---
title: "WaterAccounts"
author: "John Fay"
date: "June 7, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## See http://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html

## Install packages
```{r InstallPackages, message=FALSE, warning=FALSE}
# these are packages you will need, but probably already have.
# Don't bother installing if you already have them
install.packages(c("ggplot2", "devtools", "dplyr", "stringr"))

# some standard map packages.
install.packages(c("maps", "mapdata"))

# the github version of ggmap, which recently pulled in a small fix I had
# for a bug 
devtools::install_github("dkahle/ggmap")

```


## Import libraries
```{r Import libraries, message=FALSE, warning=FALSE}
library(dplyr)
library(magrittr)
library(ggplot2)
library(ggmap)
library(maps)
library(mapdata)
```

## Get USGS water use data
```{r Water Data}
library('data.table')
theURL <- 'http://water.usgs.gov/watuse/data/2010/usco2010.txt'
df = fread(theURL, sep='\t')
df = as.data.frame(df)
```

##Get FIPS table
```{r}
#Retrieve fips table and convert state name to lowercase
fipsTbl <- read.csv("https://raw.githubusercontent.com/ljwolf/cenpy/master/cenpy/stfipstable.csv") %>%
  mutate(
    stateName = tolower(`State.Name`)) %>%
  select(one_of(c("FIPS.Code","stateName")))

#Data table
dataTbl = tbl_df(df[0:10])


#Join state names
useTbl = left_join(dataTbl,fipsTbl,by = c("STATEFIPS" = "FIPS.Code"))
```

##Summarize on state
```{r}
stateTbl = group_by(useTbl, stateName) %>%
  summarize(totPop = sum(`TP-TotPop`, na.rm=TRUE))
```

##Join to state map
```{r}
states <- map_data("state") 
allData <- left_join(states,useTbl,c("region" = "stateName"))
```

##Map by state
```{r}
#https://gist.github.com/cdesante/4252133
p <- ggplot()
p <- p + geom_polygon(data=allData, aes(x=long, y=lat, group = group, fill=allData$`TP-TotPop`),colour="white"
      ) + scale_fill_continuous(low = "thistle2", high = "darkred", guide="colorbar")
P1 <- p + theme_bw()  + labs(fill = "legend" 
                            ,title = "Title, 2010", x="", y="")
P1 + scale_y_continuous(breaks=c()) + scale_x_continuous(breaks=c()) + theme(panel.border = element_blank())
```


